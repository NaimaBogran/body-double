<%- include('partials/loggedInHeader') -%>

<main style="display: flex; justify-content: center; align-items: center; padding: 0px; margin-top: 250px;" class="match-page">
    <div class="card" style="text-align: center; ">
    <h1>finding your <span style="color: #333294; font-weight: bold;">BODY</span><span style=" font-weight: bold; ">/</span><span style="color: #bfa1ff; font-weight: bold;">DOUBLE</span>...</h1>
    <p id="status">connecting you with a partner who matches your prefrences</p>
    </div>
</main>

<%- include('partials/footer') -%>
<script>
    //socket.io client
    const socket = io();

    const statusEl = document.getElementById("status");

    //user + filter info from server
    const userInfo = {
        userId: "<%= user._id %>",
        userName: "<%= user.userName %>",
        camera: "<%= filters.camera %>",
        workType: <%- JSON.stringify(filters.workType || []) %>
    };

    // Attach mode for server reference
    userInfo.mode = userInfo.camera === "on" ? "video" : "text";

    //ask server to find a match
    socket.emit("lookingForMatch", userInfo);

    socket.on("waiting", () => {
        statusEl.textContent = "waiting for another user to join...";
    });

    socket.on("matchFound", ({ roomId, partner, isCaller }) => {
    const myCamera = "<%= filters.camera %>"; // "on" or "off"

    statusEl.innerHTML = `
        matched with <strong>${partner.userName}</strong><br>
        connecting you now...
    `;

    // automatically redirect after delay for UI feedback
    setTimeout(() => {
        if (myCamera === "on") {
            window.location.href =
                `/videoChat/${roomId}?partnerName=${encodeURIComponent(partner.userName)}&isCaller=${isCaller}`;
        } else {
            window.location.href =
                `/textChat/${roomId}?partnerName=${encodeURIComponent(partner.userName)}`;
        }
    }, 600);
});

</script>
